<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ruby‚Äôs Cafeteria Rewards ‚Äî Display</title>

  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@600&display=swap" rel="stylesheet">

  <style>
    :root{
      --navy:#0a1f44;
      --navy2:#102b5c;
      --red:#ff5252;
    }
.vs-wrap{
  display:flex;
  align-items:center;
  justify-content:center;
}

.vs-wrap img{
  width: min(140px, 14vw);
  max-width: 160px;
  height: auto;
}
    html, body{
      height:100%;
      margin:0;
    }

    body{
      font-family:"Baloo 2", cursive;
      padding:18px;
      color:#fff;
      background:linear-gradient(var(--navy), var(--navy2));
      text-align:center;

      /* ‚úÖ bring back scrolling */
      overflow-y:auto;
      overscroll-behavior: contain;

      /* ‚úÖ snap to each lunch matchup */
      scroll-snap-type: y mandatory;
    }

    h1{
      margin: 10px 0 0;
      color: var(--red);
      font-size: clamp(46px, 4vw, 66px);
      letter-spacing: 0.5px;
    }
    .sub{
      margin: 10px 0 18px;
      opacity: .98;
      font-size: clamp(22px, 1.8vw, 30px);
    }

    .toprow{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      justify-content:center;
      align-items:center;
      margin: 10px 0 10px;
    }
    .badge{
      background:rgba(255,255,255,.12);
      border:2px solid rgba(255,255,255,.18);
      padding:8px 14px;
      border-radius:999px;
      font-size:16px;
    }

    /* Container for all matchups */
    .jars{
      display:flex;
      flex-direction:column;
      gap:26px;
      max-width: 1500px;
      margin: 14px auto 24px;
    }

    /* One matchup per screen */
    .matchup{
      scroll-snap-align: start;
      min-height: 100vh;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:18px;
      padding: 10px 0 22px;
    }

    .matchup-title{
      color:#fff;
      font-size: clamp(34px, 3.2vw, 56px);
      margin: 0;
    }

.matchup-grid{
  display:grid;
  grid-template-columns: 1fr auto 1fr;
  gap: 22px;
  align-items: center;
}
    .jar{
      background:#fff;
      color:var(--navy);
      border-radius:26px;
      padding:18px;
      box-shadow:0 12px 26px rgba(0,0,0,.25);
      min-height: 640px;  /* big for projector */
    }

    .jar h3{
      margin: 8px 0 10px;
      font-size: clamp(22px, 2.2vw, 34px);
      font-weight: 800;
      letter-spacing: 0.2px;
    }

    .points{
      font-size: clamp(34px, 3.2vw, 54px);
      margin: 10px 0 0;
      font-weight: 900;
    }

    .tiny{
      font-size: 13px;
      opacity: .85;
      margin-top: 4px;
    }

    /* Confetti */
    .confetti{
      position:fixed;
      border-radius:2px;
      z-index:9999;
      animation: fall 1100ms linear forwards;
    }
    @keyframes fall{
      to{ transform: translateY(115vh) rotate(520deg); opacity:0; }
    }

    /* +5 Banner Pop */
    .banner-pop{
      position: fixed;
      left: 50%;
      top: 90px;
      transform: translateX(-50%) translateY(-14px) scale(0.98);
      opacity: 0;
      z-index: 9999;
      pointer-events: none;
      width: min(760px, 90vw);
    }
    .banner-pop.show{
      opacity: 1;
      animation: bannerIn 220ms ease-out forwards;
    }
    @keyframes bannerIn{
      to { transform: translateX(-50%) translateY(0) scale(1); }
    }
    .banner-wrap{
      position: relative;
      filter: drop-shadow(0 14px 26px rgba(0,0,0,0.35));
    }
    .banner-img{
      width: 100%;
      height: auto;
      display: block;
    }
    .banner-text{
      position: absolute;
      left: 10%;
      top: 42%;
      width: 55%;
      text-align: left;
      font-size: clamp(28px, 3.4vw, 52px);
      line-height: 1.1;
      color: #111;
      font-weight: 800;
      text-shadow: 0 3px 0 rgba(255,255,255,0.9);
    }

    /* IMAGE-BASED JAR */
    .jar-image-wrapper{
      position: relative;
      max-width: 380px; /* ‚úÖ big jar image */
      margin: 0 auto;
    }
    .jar-image{
      width: 100%;
      display: block;
      pointer-events: none;
    }

    /* Invisible mask defines where tokens can appear */
    .jar-mask{
      position: absolute;
      left: 18%;
      right: 18%;
      top: 22%;
      bottom: 14%;
      overflow: hidden;
      pointer-events: none;
    }

    /* Fill behind tokens */
    .jar-mask .fill{
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      height: 0%;
      background: linear-gradient(#ffb3b3, #ff5252);
      opacity: 0.35;
      transition: height 0.6s ease;
      z-index: 1;
      border-radius: 12px;
    }

    /* Tokens on top */
    .jar-mask .tokens{
      position: absolute;
      inset: 0;
      z-index: 2;
      pointer-events: none;
    }

    .token{
      position:absolute;
      width:22px;
      height:22px;
      border-radius:50%;
      background:#c62828;
      box-shadow:0 2px 4px rgba(0,0,0,0.25);
    }

    .token.drop{
      animation: dropIn 450ms ease-out;
    }

    @keyframes dropIn{
      0%{
        transform: translate(-50%, -50%) translateY(-26px) scale(0.9);
        opacity: 0;
      }
      100%{
        transform: translate(-50%, -50%) translateY(0) scale(1);
        opacity: 1;
      }
    }
  </style>
</head>

<body>
  <!-- Sounds hosted on YOUR GitHub Pages -->
  <audio id="soundPlusOne" preload="auto">
    <source src="https://mnickelson-tech.github.io/cafeteria-rewards/twinkle.mp3" type="audio/mpeg">
  </audio>

  <audio id="soundPlusFive" preload="auto">
    <source src="https://mnickelson-tech.github.io/cafeteria-rewards/ding.mp3" type="audio/mpeg">
  </audio>

  <h1>üê¶ Ruby‚Äôs Cafeteria Rewards</h1>
  <div class="sub">Great expectations = great behavior üíô‚ù§Ô∏è</div>

  <div class="toprow">
    <div class="badge">üì£ Display Mode (Projector)</div>
    <div class="badge" id="status">Connecting‚Ä¶</div>
    <div class="badge" id="lastUpdate">Last update: ‚Äî</div>
  </div>

  <!-- +5 Celebration Banner -->
  <div id="bannerPop" class="banner-pop" aria-hidden="true">
    <div class="banner-wrap">
      <img class="banner-img" src="https://mnickelson-tech.github.io/cafeteria-rewards/ruby-banner-clean.png" alt="Ruby banner" />
      <div class="banner-text" id="bannerText">Grade ___</div>
    </div>
  </div>

  <div class="jars" id="jars"></div>

  <!-- Firebase (v9 compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD0ZrYRin1oQrrgLlGlOxmHvS4eiWpEQgY",
      authDomain: "cafeteria-rewards.firebaseapp.com",
      databaseURL: "https://cafeteria-rewards-default-rtdb.firebaseio.com",
      projectId: "cafeteria-rewards",
      storageBucket: "cafeteria-rewards.firebasestorage.app",
      messagingSenderId: "529945878029",
      appId: "1:529945878029:web:2e6390e70b21770e07bf44",
      measurementId: "G-2VJF6ER094"
    };

    const grades = ["PK","K","1","2","3","4","5","6"];

    const matchups = [
      { id:"PKK", title:" Pre-K vs Kinder", left:"PK", right:"K" },
      { id:"12",  title:" 1st vs 2nd",      left:"1",  right:"2" },
      { id:"34",  title:" 3rd vs 4th",      left:"3",  right:"4" },
      { id:"56",  title:" 5th vs 6th",      left:"5",  right:"6" }
    ];

    const gradeLabels = {
      "PK": "Pre-K",
      "K": "Kinder",
      "1": "1st Grade",
      "2": "2nd Grade",
      "3": "3rd Grade",
      "4": "4th Grade",
      "5": "5th Grade",
      "6": "6th Grade"
    };

    const maxPoints = 100;
    const MAX_VISIBLE_TOKENS = 80;

    const jarsEl = document.getElementById("jars");
    const statusEl = document.getElementById("status");
    const lastUpdateEl = document.getElementById("lastUpdate");

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const ref = db.ref("rewards");

    // ---- SOUND (unlock on first click anywhere) ----
    let soundUnlocked = false;

    function unlockSound(){
      if(soundUnlocked) return;

      const s1 = document.getElementById("soundPlusOne");
      const s5 = document.getElementById("soundPlusFive");
      if(!s1 || !s5) return;

      s1.volume = 0.7;
      s5.volume = 0.9;

      s1.currentTime = 0;
      s1.play().then(() => {
        s1.pause();
        s1.currentTime = 0;
        soundUnlocked = true;
        statusEl.textContent = "‚úÖ Live (Sound On)";
      }).catch(()=>{});
    }

    function playPlusOneSound(){
      if(!soundUnlocked) return;
      const s = document.getElementById("soundPlusOne");
      if(!s) return;
      s.currentTime = 0;
      s.play().catch(()=>{});
    }

    function playPlusFiveSound(){
      if(!soundUnlocked) return;
      const s = document.getElementById("soundPlusFive");
      if(!s) return;
      s.currentTime = Math.min(3.6, (s.duration || 999) - 0.05);
      s.play().catch(()=>{});
    }

    ["click", "touchstart", "keydown"].forEach(evt => {
      document.addEventListener(evt, unlockSound, { once: true });
    });

    // ---- CONFETTI ----
    function confetti(){
      const colors = ["#ff5252","#ffd700","#4caf50","#2196f3","#ff8a65","#ab47bc"];
      for(let i=0;i<60;i++){
        const c = document.createElement("div");
        c.className = "confetti";
        c.style.left = Math.random()*100 + "vw";
        c.style.top  = (-10 - Math.random()*30) + "px";
        c.style.background = colors[Math.floor(Math.random()*colors.length)];
        const sz = (8 + Math.random()*6);
        c.style.width = sz + "px";
        c.style.height = sz + "px";
        document.body.appendChild(c);
        setTimeout(()=>c.remove(), 1100);
      }
    }

    // ---- BANNER ----
    function showBannerForGrade(grade){
      const pop = document.getElementById("bannerPop");
      const txt = document.getElementById("bannerText");
      if(!pop || !txt) return;

      txt.textContent = `${gradeLabels[grade]}`;

      pop.classList.remove("show");
      void pop.offsetWidth;
      pop.classList.add("show");

      clearTimeout(window.__bannerTimer);
      window.__bannerTimer = setTimeout(() => {
        pop.classList.remove("show");
      }, 2200);
    }

    // ---- TOKENS ----
    function slotPosition(areaEl, index){
      const rect = areaEl.getBoundingClientRect();

      const size = 22;
      const gap = 4;
      const padX = 6;
      const padBottom = 6;

      const usableW = rect.width - padX*2;
      const cols = Math.max(1, Math.floor(usableW / (size + gap)));

      const row = Math.floor(index / cols);
      const col = index % cols;

      const x = padX + (col + 0.5) * (usableW / cols);

      // stack from bottom up
      const yFromBottom = (row + 0.5) * (size + gap);
      const y = rect.height - padBottom - yFromBottom;

      const jitter = (n) => (Math.sin((index+1)*999) * 0.5 + 0.5) * n - n/2;
      return { left: x + jitter(4), top: y + jitter(4) };
    }

    function drawTokens(grade, count, added = 0){
      const maskEl = document.querySelector(`#jar_${grade} .jar-mask`);
      const layer = document.getElementById("tokens_" + grade);
      if(!maskEl || !layer) return;

      const visible = Math.min(count, MAX_VISIBLE_TOKENS);
      layer.innerHTML = "";

      const startDropIndex = Math.max(0, visible - added);

      for(let i = 0; i < visible; i++){
        const t = document.createElement("div");
        t.classList.add("token");

        if(added > 0 && i >= startDropIndex){
          t.classList.add("drop");
          if(added >= 5) t.style.animationDuration = "600ms";
        } else {
          t.style.transform = "translate(-50%, -50%)";
        }

        const pos = slotPosition(maskEl, i);
        t.style.left = pos.left + "px";
        t.style.top  = pos.top  + "px";

        layer.appendChild(t);
      }
    }

   function renderUI(){
  jarsEl.innerHTML = "";

  matchups.forEach(m => {
    const section = document.createElement("section");
    section.className = "matchup";
    section.id = "matchup_" + m.id;

    section.innerHTML = `
      <h2 class="matchup-title">${m.title}</h2>
      <div class="matchup-grid" id="grid_${m.id}"></div>
    `;

    jarsEl.appendChild(section);

    const grid = section.querySelector("#grid_" + m.id);

    // LEFT jar
    const leftCard = document.createElement("div");
    leftCard.className = "jar";
    leftCard.innerHTML = `
      <h3>${gradeLabels[m.left]}</h3>

      <div class="jar-image-wrapper" id="jar_${m.left}">
        <img
          src="https://mnickelson-tech.github.io/cafeteria-rewards/campbell-jar.png"
          class="jar-image"
          alt="Rewards Jar"
        />
        <div class="jar-mask">
          <div class="fill" id="fill_${m.left}"></div>
          <div class="tokens" id="tokens_${m.left}"></div>
        </div>
      </div>

      <div class="points" id="pts_${m.left}">0</div>
      <div class="tiny">Tokens stack as points grow</div>
    `;
    grid.appendChild(leftCard);

    // VS GIF (center)
    const vs = document.createElement("div");
    vs.className = "vs-wrap";
    vs.innerHTML = `
      <img src="https://mnickelson-tech.github.io/cafeteria-rewards/vs.gif" alt="VS">
    `;
    grid.appendChild(vs);

    // RIGHT jar
    const rightCard = document.createElement("div");
    rightCard.className = "jar";
    rightCard.innerHTML = `
      <h3>${gradeLabels[m.right]}</h3>

      <div class="jar-image-wrapper" id="jar_${m.right}">
        <img
          src="https://mnickelson-tech.github.io/cafeteria-rewards/campbell-jar.png"
          class="jar-image"
          alt="Rewards Jar"
        />
        <div class="jar-mask">
          <div class="fill" id="fill_${m.right}"></div>
          <div class="tokens" id="tokens_${m.right}"></div>
        </div>
      </div>

      <div class="points" id="pts_${m.right}">0</div>
      <div class="tiny">Tokens stack as points grow</div>
    `;
    grid.appendChild(rightCard);
  });
}
       
   

  let lastTs = 0;
let lastPoints = {};

renderUI();
    
    ref.on("value", snap=>{
      statusEl.textContent = soundUnlocked ? "‚úÖ Live (Sound On)" : "‚úÖ Live";

      const data = snap.val() || {};
      const points = data.points || {};
      const event = data.lastEvent || null;

      grades.forEach(g=>{
        const v = points[g] || 0;

        const ptsEl = document.getElementById("pts_"+g);
        const fillEl = document.getElementById("fill_"+g);

        if(ptsEl) ptsEl.textContent = v;

        if(fillEl){
          const pct = Math.min((v/maxPoints)*100, 100);
          fillEl.style.height = (pct < 2 ? 0 : pct) + "%";
        }

        const prev = lastPoints[g] || 0;
        const added = Math.max(0, v - prev);
        drawTokens(g, v, added);
        lastPoints[g] = v;
      });

      if(event && event.ts && event.ts > lastTs){
        lastTs = event.ts;
        lastUpdateEl.textContent = "Last update: " + new Date(event.ts).toLocaleTimeString();

        if(event.type === "add"){
          const amt = Number(event.amount ?? 1);
          confetti();

          if(amt >= 5){
            playPlusFiveSound();
            showBannerForGrade(event.grade || "");
          } else {
            playPlusOneSound();
          }
        }
      } else {
        lastUpdateEl.textContent = "Last update: " + new Date().toLocaleTimeString();
      }
    }, err=>{
      statusEl.textContent = "‚ö†Ô∏è Not connected";
      console.error(err);
    });

    window.addEventListener("resize", ()=>{
      ref.get().then(snap=>{
        const data = snap.val() || {};
        const points = (data.points || {});
        grades.forEach(g => drawTokens(g, points[g]||0, 0));
      });
    });
  </script>
</body>
</html>


